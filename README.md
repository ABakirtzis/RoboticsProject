# RoboticsProject

# Περιγραφή:

Με χρήση της πλατφόρμας ROS και του περιβάλλοντος προσομοίωσης Gazebo ζητείται να αναπτυχθεί εφαρμογή που θα επιτρέπει σε μία κινούμενη διάταξη να ακολουθεί τα τοιχώματα (wall following) του περιβάλλοντος στο οποίο βρίσκεται, να εκτιμά τη θέση και τον προσανατολισμό του σε γνωστό χάρτη, με χρήση επεκτεταμένου φίλτρου Kalman, καθώς και να κινείται προς επιθυμητό στόχο, αποφεύγοντας γνωστά εμπόδια.

# Περιγραφή Διάταξης:

## Calibration του μαγνητομέτρου:

Το μαγνητόμετρο δεν ήταν καλά ρυθμισμένο στην συγκεκριμένη διάταξη. Με λήψη τιμών καθώς περιστρεφόταν το μαγνητόμετρο με τον άξονα z κατακόρυφο φάνηκε ότι το ελλειψοειδές που δημιουργούσαν τα ζεύγη τιμών x,y ήταν έκκεντρο. Η συγκεκριμένη απόκλιση φάνηκε να τείνει προς την κατεύθυνση στην οποία βρισκόντουσαν οι μπαταρίες στην συγκεκριμένη διάταξη. Το λανθασμένο ελλειψοειδές και το διορθωμένο φαίνονται στο παρακάτω διάγραμμα:

![calibration](/project/scripts/magnetometer_calibration.png)

# Wall following:

Το wall following αποτελείται από τρεις καταστάσεις:

  - __State 0__

Εδώ το ρομπότ δεν βλέπει τοίχο με το left sonar. Προκειμένου να δει τοίχο και να είναι έτοιμο το ρομπότ να κινηθεί δεξιόστροφα, δίνεται γραμμική ταχύτητα 0.18 και μικρή γωνιακή ταχύτητα -0.3, ώστε να μην υπάρξει περίπτωση να μην βλέπει κανένα sonar τοίχο λόγω ασθενούς διάχυσης. Ανάλογα με το ποιο σόναρ από τα υπόλοιπα βλέπει, διακρίνεται ο αλγόριθμος σε substates, καθένα εκ των οποίων χρησιμοποιεί τον δικό του PD controller, προκειμένου να έρθει το ρομπότ όσο παράλληλα γίνεται στον τοίχο, πριν βλέπει σε επιθυμητή απόσταση το left sonar.

  - __State 1__

Εδώ το ρομπότ είναι σχεδόν παράλληλο στον τοίχο και προσπαθεί να παραμείνει παράλληλο, ακολουθώντας τον τοίχο σε επιθυμητή απόσταση.

  - __State 2__

Εδώ το ρομπότ τίθεται σε δεξιά στροφή για πειραματικά προσδιορισμένο χρονικό διάστημα. Ο αλγόριθμος φτάνει σε αυτήν την κατάσταση εάν οποιαδήποτε στιγμή δει το front sonar σε αρκετά μικρή απόσταση. Έπειτα από αυτήν την στροφή, επιστρέφει ο αλγόριθμος στο state 1.

## Πειραματικά αποτελέσματα:

# State estimation:

Για την εκτίμηση της θέσης και της γωνίας του ρομπότ χρησιμοποιήθηκε επεκτεταμένο φίλτρο Kalman. Το μοντέλο έχει διάνυσμα κατάστασης Χ την θέση και την γωνία του ρομπότ με:

![equation](http://www.sciweavers.org/upload/Tex2Img_1564682937/render.png)

 Για την εκτίμηση της θέσης χρησιμοποιήθηκαν οι μετρήσεις των σόναρ στον πίνακα μετρήσεων και στο μοντέλο μία εκτίμηση της μέσης ταχύτητας του ρομπότ όταν του δινόταν εντολή να κινηθεί με ταχύτητα 0.2. Η μέση τιμή αυτή προέκυψε 0.148 m/s από 20 μετρήσεις από τις οποίες εξήχθη και η τυπική απόκλιση 0.00474 m/s. Για την εκτίμηση της γωνίας χρησιμοποιήθηκε το μαγνητόμετρο στον πίνακα των μετρήσεων και η γωνιακή ταχύτητα στο μοντέλο. Δεδομένων αυτών, ο πίνακας Φ του φίλτρου προέκυψε:

![equation](http://www.sciweavers.org/upload/Tex2Img_1564682735/render.png)

Και ο πίνακας w:

![equation](http://www.sciweavers.org/upload/Tex2Img_1564683234/render.png)

Από τον πίνακα Φ προκύπτει ο πίνακας Α από γραμμικοποίηση που χρησιμοποιείται στο φίλτρο Kalman:

![equation](http://www.sciweavers.org/upload/Tex2Img_1564683579/render.png)

Και ο πίνακας αβεβαιότητας του μοντέλου τελικά είναι:

![equation](http://www.sciweavers.org/upload/Tex2Img_1564683745/render.png)

Για τον πίνακα μετρήσεων z ισχύει ότι:

![equation](http://www.sciweavers.org/upload/Tex2Img_1564683837/render.png)

Όπου L, FL, F, FR, R οι μετρήσεις των σόναρ και θ<sub>imu</sub> η μέτρηση του μαγνητομέτρου.

Ο πίνακας h δημιουργείται σε κάθε βήμα ξεχωριστά, διότι μερικές μετρήσεις των σόναρ μπορεί να μην γίνουν αποδεκτές, οπότε παραλείπονται και οι αντίστοιχες γραμμές του h. Πιο συγκεκριμένα, αν η μέτρηση ενός σόναρ είναι πάνω από κάποιο όριο, πειραματικά προσδιορισμένο, η μέτρηση απορρίπτεται και μαζί του και η αντίστοιχη γραμμή στον πίνακα h. Ακόμη, μέσω του μοντέλου υπολογίζεται η εκτίμηση της θέσης και της γωνίας του ρομπότ την συγκεκριμένη χρονική στιγμή. Μέσω αυτής προσδιορίζεται ο τοίχος στον οποίο βλέπει κάθε σόναρ, καθώς και η γωνία με την οποία προσπίπτει στο τοίχωμα η ηχητική δέσμη. Αν η γωνία αυτή είναι μεγαλύτερη από ένα επίσης πειραματικά προσδιορισμένο όριο της τάξης των 25 μοιρών, τότε αυτή η μέτρηση δεν χρησιμοποιείται, καθώς από το όριο αυτό και πάνω η ανάκλαση είναι τέτοια που δεν επιτρέπει στον αισθητήρα να λάβει πίσω την διαχεόμενη ηχητική δέσμη. Για τον προσδιορισμό του τοιχώματος στο οποίο κοιτάει κάποιο σόναρ χρησιμοποιούνται οι εξισώσεις των ευθειών και τα άκρα των ευθυγράμμων τμημάτων που ορίζουν οι τοίχοι. Με βάση αυτά επίσης προσδιορίζονται και οι εξισώσεις που θα αποτελέσουν τον πίνακα h. Κάθε εξίσωση είναι της μορφής:

![equation](http://www.sciweavers.org/upload/Tex2Img_1564682832/render.png)

όπου d<sub>i</sub> η απόσταση του σόναρ από τον τοίχο και θ<sub>i</sub> η κυρτή γωνία που ορίζεται από την ευθεία στην οποία βλέπει το σόναρ και την κάθετο στον τοίχο. Το συνημίτονο αυτής ισούται με το ημίτονο της κυρτής γωνίας που ορίζεται από την ευθεία του σόναρ και την ευθεία του τοίχου, πράγμα πιο εύκολα υπολογίσιμο. Όλα αυτά υπολογίζονται χρησιμοποιώντας την βιβλιοθήκη sympy της python ώστε να προκύψουν εκφράσεις με παραμέτρους τα x, y, θ του ρομπότ. Αυτές απλοποιούνται όσο γίνεται και παραγωγίζονται ως προς όλα τα στοιχεία του διανύσματος κατάστασης, ώστε να χρησιμοποιηθούν για την δημιουργία του H ύστερα, το οποίο προκύπτει από γραμμικοποίηση του h:

![equation](http://www.sciweavers.org/upload/Tex2Img_1564683432/render.png)

Με αυτούς τους πίνακες έτοιμους, μπορεί να υλοποιηθεί η συνάρτηση που κάνει την αναβάθμιση του διανύσματος κατάστασης και της αβεβαιότητας με χρήση των σχέσεων που υπαγορεύει η αντίστοιχη θεωρία.
Λόγω της καθυστέρησης της python να εκτελέσει πράξεις μεταξύ πινάκων, τυγχάνει το Kalman να υπολογίσει την τρέχουσα εκτιμώμενη θέση του ρομπότ βάσει προηγούμενων ενδείξεων των σόναρς και όχι των τρέχοντων. Για να διορθωθεί αυτό, η εκτίμηση θέσης περνά στο τέλος από το μοντέλο συστήματος, με dt το χρόνο από τη στιγμή που λαμβάνουμε την μέτρηση μέχρι την στιγμή που περνάμε από το μοντέλο την εκτίμηση θέσης.

# Προβλήματα/Αστοχίες Υλικού

Κατά τη διάρκεια υλοποίησης του project διαπιστώθηκαν αρκετά προβλήματα στη λειτουργία του robot.

1. Οι αισθητήρες sonar όταν βλέπουν εμπόδια/τοίχους με γωνία μεγαλύτερη των ~30 μοιρών δεν επιστρέφουν σωστές μετρήσεις και θεωρούν ότι τα εν λόγω εμπόδια βρίσκονται πιο μακριά από ότι στην πραγματικότητα.
  Αντιμετώπιση: Φιτράρισμα των μετρήσεων των sonars, ώστε να αγνοούνται αποπροσανατολισμένες μετρήσεις.

2. Η μπροστινή ρόδα του ρομπότ, συχνά δυσκόλευε την κίνηση του robot, καθώς δεν μπορούσε να στρίψει όπως έπρεπε. Κυρίως το πρόβλημα παρατηρήθηκε όταν το power bank που χρησιμοποιήθηκε βρισκόταν στη μέση του robot, στον χώρο που είχε προβλεφθεί να μείνει κενός για αυτό το σκοπό.
  Αντιμετώπιση: Αλλαγή θέση του power bank με τις μπαταρίες τροφοδοσίας των κινητήρων, ώστε να αλλάξει το κέντρο βάρους το ρομπότ και να μην έχει τόσο βάρος η μπροστινή ρόδα.

3. Κατά τη διάρκεια υλοποίησης του Kalman Filter παρατηρήθηκε ότι υπερθερμαίνεται ο επεξεργαστής του Rasberry Pi και δεν λαμβάνεται ικανοποιητικός αριθμός δειγμάτων, με αποτέλεσμα να έχουμε ίχνος της τροχιάς κίνησης του robot και όχι in real time motion.
  Αντιμετώπιση: Αλλάξαμε την πλακέτα του Rasberry Pi από τη 2 στη 2b.

4. Καθώς δεν υπάρχουν αισθητήρες στους κινητήρες για οδομετρία, ήταν αδύνατο να μπορέσουμε να ελέγξουμε αν ακολουθείται η τροχία που μας επιστρέφει το kalman.
  Αντιμετώπιση: Βιντεοσκόπηση της κίνησης του robot και σύγκριση του βίντεο με την τροχία του αντίστοιχου διαγράμματος.
